<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier - Mbeka</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Mbeka" class="logo-large">
                <div class="logo-text">
                    <h1><i class="fas fa-calendar-alt"></i> Calendrier & Planning</h1>
                    <p class="subtitle">Vue d'ensemble de votre activité</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('index') }}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </header>

        <nav class="main-nav">
            <a href="{{ url_for('index') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="{{ url_for('calendrier') }}" class="nav-link active">
                <i class="fas fa-calendar-alt"></i> Calendrier
            </a>
            <a href="{{ url_for('factures') }}" class="nav-link">
                <i class="fas fa-receipt"></i> Factures
            </a>
            <a href="{{ url_for('employes') }}" class="nav-link">
                <i class="fas fa-users"></i> Employés
            </a>
            <a href="{{ url_for('sauvegardes') }}" class="nav-link">
                <i class="fas fa-database"></i> Sauvegardes
            </a>
        </nav>

        <main class="main-content">
            <!-- Navigation du calendrier -->
            <div class="calendar-controls">
                <button class="btn-nav" onclick="moisPrecedent()">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                <h2 id="calendar-title">Décembre 2024</h2>
                <button class="btn-nav" onclick="moisSuivant()">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
                <button class="btn-today" onclick="allerAujourdhui()">
                    <i class="fas fa-calendar-day"></i> Aujourd'hui
                </button>
            </div>

            <!-- Statistiques du mois -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498DB;">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="stat-livraisons">0</h3>
                        <p>Livraisons ce mois</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #2ecc71;">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="stat-journaux">0</h3>
                        <p>Journaux livrés</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6;">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="stat-factures">0</h3>
                        <p>Factures émises</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="stat-amendes">0 €</h3>
                        <p>Amendes</p>
                    </div>
                </div>
            </div>

            <!-- Calendrier -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-day-name">Lun</div>
                    <div class="calendar-day-name">Mar</div>
                    <div class="calendar-day-name">Mer</div>
                    <div class="calendar-day-name">Jeu</div>
                    <div class="calendar-day-name">Ven</div>
                    <div class="calendar-day-name">Sam</div>
                    <div class="calendar-day-name">Dim</div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Généré dynamiquement -->
                </div>
            </div>

            <!-- Légende -->
            <div class="calendar-legend">
                <h3><i class="fas fa-info-circle"></i> Légende</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #3498DB;"></span>
                        <span>Livraisons</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #2ecc71;"></span>
                        <span>Factures payées</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #e74c3c;"></span>
                        <span>Factures impayées</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #f39c12;"></span>
                        <span>Amendes</span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; {{ now.year }} {{ entreprise.nom }}</p>
        </footer>
    </div>

    <!-- Modal détails du jour -->
    <div id="modalJour" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day"></i> Détails du <span id="modal-date"></span></h3>
                <button class="btn-close" onclick="fermerModalJour()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="details-jour">
                    <!-- Chargé dynamiquement -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="fermerModalJour()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let evenementsCache = {};
        
        // Charger le calendrier au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            chargerCalendrier();
        });
        
        async function chargerCalendrier() {
            try {
                const annee = currentDate.getFullYear();
                const mois = currentDate.getMonth() + 1;
                
                const response = await fetch(`/api/calendrier/mois?annee=${annee}&mois=${mois}`);
                const data = await response.json();
                
                if (response.ok) {
                    afficherCalendrier(data);
                    afficherStatistiques(data.stats);
                    evenementsCache = grouperEvenements(data.evenements);
                } else {
                    console.error('Erreur:', data.error);
                }
            } catch (error) {
                console.error('Erreur chargement calendrier:', error);
            }
        }
        
        function grouperEvenements(evenements) {
            const groupes = {};
            evenements.forEach(evt => {
                if (!groupes[evt.date]) {
                    groupes[evt.date] = [];
                }
                groupes[evt.date].push(evt);
            });
            return groupes;
        }
        
        function afficherCalendrier(data) {
            // Mettre à jour le titre
            const moisNoms = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            document.getElementById('calendar-title').textContent = 
                `${moisNoms[data.mois - 1]} ${data.annee}`;
            
            // Créer la grille du calendrier
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const annee = data.annee;
            const mois = data.mois;
            const premierJour = new Date(annee, mois - 1, 1);
            const dernierJour = new Date(annee, mois, 0);
            
            // Jour de la semaine du premier jour (0 = dimanche, 1 = lundi, etc.)
            let premierJourSemaine = premierJour.getDay();
            // Ajuster pour que lundi = 0
            premierJourSemaine = premierJourSemaine === 0 ? 6 : premierJourSemaine - 1;
            
            // Ajouter les jours vides avant le premier jour
            for (let i = 0; i < premierJourSemaine; i++) {
                const celluleVide = document.createElement('div');
                celluleVide.className = 'calendar-day empty';
                grid.appendChild(celluleVide);
            }
            
            // Ajouter les jours du mois
            for (let jour = 1; jour <= dernierJour.getDate(); jour++) {
                const dateStr = `${annee}-${String(mois).padStart(2, '0')}-${String(jour).padStart(2, '0')}`;
                const cellule = document.createElement('div');
                cellule.className = 'calendar-day';
                
                // Vérifier si c'est aujourd'hui
                const aujourdhui = new Date();
                if (annee === aujourdhui.getFullYear() && 
                    mois === aujourdhui.getMonth() + 1 && 
                    jour === aujourdhui.getDate()) {
                    cellule.classList.add('today');
                }
                
                // Numéro du jour
                const numJour = document.createElement('div');
                numJour.className = 'day-number';
                numJour.textContent = jour;
                cellule.appendChild(numJour);
                
                // Événements du jour
                if (evenementsCache[dateStr]) {
                    const evts = evenementsCache[dateStr];
                    const container = document.createElement('div');
                    container.className = 'events-container';
                    
                    evts.forEach(evt => {
                        const badge = document.createElement('div');
                        badge.className = 'event-badge';
                        
                        if (evt.type === 'livraison') {
                            badge.style.background = '#3498DB';
                            badge.innerHTML = `<i class="fas fa-truck"></i> ${evt.journaux}`;
                        } else if (evt.type === 'facture') {
                            if (evt.statut === 'payee') {
                                badge.style.background = '#2ecc71';
                            } else {
                                badge.style.background = '#e74c3c';
                            }
                            badge.innerHTML = `<i class="fas fa-file-invoice"></i> ${evt.montant.toFixed(0)}€`;
                        } else if (evt.type === 'amende') {
                            badge.style.background = '#f39c12';
                            badge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${evt.montant}€`;
                        }
                        
                        container.appendChild(badge);
                    });
                    
                    cellule.appendChild(container);
                    cellule.classList.add('has-events');
                    cellule.onclick = () => afficherDetailsJour(dateStr);
                }
                
                grid.appendChild(cellule);
            }
        }
        
        function afficherStatistiques(stats) {
            document.getElementById('stat-livraisons').textContent = stats.total_livraisons;
            document.getElementById('stat-journaux').textContent = stats.total_journaux;
            document.getElementById('stat-factures').textContent = stats.total_factures;
            document.getElementById('stat-amendes').textContent = stats.total_amendes.toFixed(2) + ' €';
        }
        
        async function afficherDetailsJour(dateStr) {
            try {
                const response = await fetch(`/api/calendrier/jour?date=${dateStr}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Formater la date
                    const date = new Date(dateStr + 'T00:00:00');
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    document.getElementById('modal-date').textContent = 
                        date.toLocaleDateString('fr-FR', options);
                    
                    // Créer le contenu
                    let html = '';
                    
                    // Livraisons
                    if (data.livraisons.length > 0) {
                        html += '<div class="detail-section">';
                        html += '<h4><i class="fas fa-truck"></i> Livraisons</h4>';
                        html += '<table class="detail-table">';
                        html += '<tr><th>Employé</th><th>Journaux</th><th>Montant</th></tr>';
                        data.livraisons.forEach(l => {
                            html += `<tr><td>${l.employe}</td><td>${l.journaux}</td><td>${l.montant.toFixed(2)} €</td></tr>`;
                        });
                        html += '</table></div>';
                    }
                    
                    // Factures
                    if (data.factures.length > 0) {
                        html += '<div class="detail-section">';
                        html += '<h4><i class="fas fa-file-invoice"></i> Factures</h4>';
                        html += '<table class="detail-table">';
                        html += '<tr><th>N°</th><th>Type</th><th>Destinataire</th><th>Montant</th><th>Statut</th></tr>';
                        data.factures.forEach(f => {
                            const statut = f.statut === 'payee' ? '✅ Payée' : '❌ Impayée';
                            html += `<tr><td>${f.numero}</td><td>${f.type}</td><td>${f.destinataire}</td><td>${f.montant.toFixed(2)} €</td><td>${statut}</td></tr>`;
                        });
                        html += '</table></div>';
                    }
                    
                    // Amendes
                    if (data.amendes.length > 0) {
                        html += '<div class="detail-section">';
                        html += '<h4><i class="fas fa-exclamation-triangle"></i> Amendes</h4>';
                        html += '<table class="detail-table">';
                        html += '<tr><th>Employé</th><th>Motif</th><th>Montant</th></tr>';
                        data.amendes.forEach(a => {
                            html += `<tr><td>${a.employe}</td><td>${a.motif}</td><td>${a.montant.toFixed(2)} €</td></tr>`;
                        });
                        html += '</table></div>';
                    }
                    
                    // Totaux
                    html += '<div class="detail-section totaux">';
                    html += '<h4><i class="fas fa-calculator"></i> Totaux du jour</h4>';
                    html += `<p><strong>Livraisons :</strong> ${data.totaux.livraisons} (${data.totaux.journaux} journaux)</p>`;
                    html += `<p><strong>Factures :</strong> ${data.totaux.factures} (${data.totaux.ca.toFixed(2)} €)</p>`;
                    html += `<p><strong>Amendes :</strong> ${data.totaux.amendes.toFixed(2)} €</p>`;
                    html += '</div>';
                    
                    if (html === '') {
                        html = '<p>Aucun événement ce jour.</p>';
                    }
                    
                    document.getElementById('details-jour').innerHTML = html;
                    document.getElementById('modalJour').style.display = 'block';
                } else {
                    alert('Erreur: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de chargement');
            }
        }
        
        function fermerModalJour() {
            document.getElementById('modalJour').style.display = 'none';
        }
        
        function moisPrecedent() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            chargerCalendrier();
        }
        
        function moisSuivant() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            chargerCalendrier();
        }
        
        function allerAujourdhui() {
            currentDate = new Date();
            chargerCalendrier();
        }
        
        // Fermer modal en cliquant dehors
        window.onclick = function(event) {
            const modal = document.getElementById('modalJour');
            if (event.target == modal) {
                fermerModalJour();
            }
        };
    </script>

    <style>
        .calendar-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .calendar-controls h2 {
            margin: 0;
            color: #2C3E50;
            flex: 1;
            text-align: center;
        }
        
        .btn-nav, .btn-today {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-nav {
            background: #3498DB;
            color: white;
        }
        
        .btn-nav:hover {
            background: #2980b9;
        }
        
        .btn-today {
            background: #2ecc71;
            color: white;
        }
        
        .btn-today:hover {
            background: #27ae60;
        }
        
        .calendar-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .calendar-day-name {
            text-align: center;
            font-weight: 700;
            color: #2C3E50;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 8px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s;
        }
        
        .calendar-day.empty {
            background: #f8f9fa;
            border: none;
        }
        
        .calendar-day.today {
            border-color: #3498DB;
            background: #ebf5fb;
        }
        
        .calendar-day.has-events {
            cursor: pointer;
        }
        
        .calendar-day.has-events:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .day-number {
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 5px;
        }
        
        .events-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .event-badge {
            font-size: 11px;
            padding: 4px 6px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .event-badge i {
            font-size: 10px;
        }
        
        .calendar-legend {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .calendar-legend h3 {
            margin: 0 0 15px 0;
            color: #2C3E50;
        }
        
        .legend-items {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .detail-section:last-child {
            border-bottom: none;
        }
        
        .detail-section h4 {
            margin: 0 0 15px 0;
            color: #2C3E50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .detail-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .detail-table td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .detail-section.totaux {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .detail-section.totaux p {
            margin: 8px 0;
        }
        
        .modal-large {
            max-width: 900px;
        }
        <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
</body>
    </style>
</body>
</html>


