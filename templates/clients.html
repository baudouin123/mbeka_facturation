<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Clients - Mbeka</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Mbeka" class="logo-large">
                <div class="logo-text">
                    <h1><i class="fas fa-building"></i> Gestion des Clients</h1>
                    <p class="subtitle">Gérez vos entreprises partenaires</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('index') }}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </header>

        <nav class="main-nav">
            <a href="{{ url_for('index') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('nouvelle_facture_client') }}" class="nav-link">
                <i class="fas fa-file-invoice-dollar"></i> Facture Client
            </a>
            <a href="{{ url_for('clients') }}" class="nav-link active">
                <i class="fas fa-building"></i> Clients
            </a>
            <a href="{{ url_for('employes') }}" class="nav-link">
                <i class="fas fa-users"></i> Employés
            </a>
            <a href="{{ url_for('factures') }}" class="nav-link">
                <i class="fas fa-receipt"></i> Factures
            </a>
        </nav>

        <main class="main-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498DB;">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.total_clients }}</h3>
                        <p>Clients Total</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #2ecc71;">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.total_factures }}</h3>
                        <p>Factures émises</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6;">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ "%.2f"|format(stats.total_ca) }} €</h3>
                        <p>Chiffre d'affaires</p>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Liste des clients</h2>
                    <div class="header-actions">
                        <button class="btn-add" onclick="ouvrirModalClient()">
                            <i class="fas fa-plus"></i> Nouveau Client
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom de l'entreprise</th>
                                <th>Ville</th>
                                <th>Contact</th>
                                <th>SIRET</th>
                                <th>Nb Factures</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr id="client-row-{{ client.id }}">
                                <td><strong>{{ client.nom }}</strong></td>
                                <td>{{ client.ville }}</td>
                                <td>
                                    {% if client.email %}<i class="fas fa-envelope"></i> {{ client.email }}<br>{% endif %}
                                    {% if client.telephone %}<i class="fas fa-phone"></i> {{ client.telephone }}{% endif %}
                                </td>
                                <td>{{ client.siret }}</td>
                                <td>
                                    <span class="badge badge-info">{{ client.factures|length }} factures</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action" title="Modifier" 
                                                onclick='editerClient({{ client.to_dict()|tojson }})'>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <button class="btn-action btn-danger" title="Supprimer" 
                                                onclick="supprimerClient({{ client.id }}, '{{ client.nom }}', {{ client.factures|length }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="empty-state-small">Aucun client enregistré.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; {{ now.year }} {{ entreprise.nom }}</p>
        </footer>
    </div>

    <div id="modalClient" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-building"></i> <span id="modalTitle">Nouveau Client</span></h3>
                <button class="btn-close" onclick="fermerModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="formClient">
                    <input type="hidden" id="client_id">
                    
                    <div class="form-group">
                        <label for="nom">Nom de l'entreprise *</label>
                        <input type="text" id="nom" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ville">Ville</label>
                            <input type="text" id="ville" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="adresse">Adresse</label>
                            <input type="text" id="adresse" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="telephone">Téléphone</label>
                            <input type="text" id="telephone" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="siret">Numéro SIRET</label>
                        <input type="text" id="siret" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_tva">Numéro de TVA</label>
                        <input type="text" id="numero_tva" class="form-control" placeholder="Ex: BE0123456789">
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="fermerModal()">Annuler</button>
                <button class="btn-primary" onclick="sauvegarderClient()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        // --- GESTION DE LA MODALE ---
        function ouvrirModalClient() {
            document.getElementById('modalTitle').textContent = 'Nouveau Client';
            document.getElementById('formClient').reset();
            document.getElementById('client_id').value = '';
            document.getElementById('modalClient').style.display = 'block';
        }

        function editerClient(client) {
            document.getElementById('modalTitle').textContent = 'Modifier Client';
            document.getElementById('client_id').value = client.id;
            document.getElementById('nom').value = client.nom;
            document.getElementById('ville').value = client.ville || '';
            document.getElementById('adresse').value = client.adresse || '';
            document.getElementById('email').value = client.email || '';
            document.getElementById('telephone').value = client.telephone || '';
            document.getElementById('siret').value = client.siret || '';
            document.getElementById('numero_tva').value = client.numero_tva || '';
            
            document.getElementById('modalClient').style.display = 'block';
        }

        function fermerModal() {
            document.getElementById('modalClient').style.display = 'none';
        }

        // --- SAUVEGARDER (Création ou Modif) ---
        async function sauvegarderClient() {
            const id = document.getElementById('client_id').value;
            const nom = document.getElementById('nom').value;
            
            if(!nom) { alert("Le nom est obligatoire"); return; }

            const data = {
                nom: nom,
                ville: document.getElementById('ville').value,
                adresse: document.getElementById('adresse').value,
                email: document.getElementById('email').value,
                telephone: document.getElementById('telephone').value,
                siret: document.getElementById('siret').value
                numero_tva: document.getElementById('numero_tva').value
            };

            const url = id ? `/api/clients/${id}` : '/api/clients';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Client enregistré avec succès !');
                    location.reload(); // Recharge la page pour voir les changements
                } else {
                    alert('Erreur lors de l\'enregistrement.');
                }
            } catch (e) {
                alert('Erreur de connexion.');
            }
        }

        // --- SUPPRIMER ---
        async function supprimerClient(id, nom, nbFactures) {
            if (nbFactures > 0) {
                alert(`Impossible de supprimer ${nom} car il possède ${nbFactures} factures. Supprimez d'abord ses factures.`);
                return;
            }

            if (!confirm(`Voulez-vous vraiment supprimer le client "${nom}" ?`)) return;

            try {
                const response = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.getElementById(`client-row-${id}`).remove();
                    alert('Client supprimé.');
                } else {
                    alert('Erreur lors de la suppression.');
                }
            } catch (e) {
                alert('Erreur de connexion.');
            }
        }

        // Fermer si on clique dehors
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalClient')) {
                fermerModal();
            }
        }
    </script>
    
    <style>
        /* Styles spécifiques pour le bouton danger */
        .btn-danger { color: #e74c3c !important; }
        .btn-danger:hover { background: #e74c3c !important; color: white !important; }
    </style>
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
</body>
</html>


