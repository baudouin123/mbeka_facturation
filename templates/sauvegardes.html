<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sauvegardes - Mbeka</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Mbeka" class="logo-large">
                <div class="logo-text">
                    <h1><i class="fas fa-database"></i> Gestion des Sauvegardes</h1>
                    <p class="subtitle">Prot√©gez vos donn√©es avec des sauvegardes r√©guli√®res</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('index') }}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </header>

        <nav class="main-nav">
            <a href="{{ url_for('index') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('nouvelle_facture_client') }}" class="nav-link">
                <i class="fas fa-file-invoice-dollar"></i> Facture Client
            </a>
            <a href="{{ url_for('nouvelle_facture_employe') }}" class="nav-link">
                <i class="fas fa-user-tie"></i> Facture Employ√©
            </a>
            <a href="{{ url_for('employes') }}" class="nav-link">
                <i class="fas fa-users"></i> Employ√©s
            </a>
            <a href="{{ url_for('clients') }}" class="nav-link">
                <i class="fas fa-building"></i> Clients
            </a>
            <a href="{{ url_for('factures') }}" class="nav-link">
                <i class="fas fa-receipt"></i> Factures
            </a>
            <a href="{{ url_for('documents') }}" class="nav-link">
               <i class="fas fa-folder-open"></i> Documents
            </a>
        </nav>

        <main class="main-content">
            <!-- Actions de sauvegarde -->
            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-save"></i> Actions</h2>
                    <button class="btn-add" onclick="creerSauvegarde()">
                        <i class="fas fa-plus"></i> Cr√©er une sauvegarde maintenant
                    </button>
                </div>
                
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>üí° Conseil :</strong> Cr√©ez des sauvegardes r√©guli√®res de votre base de donn√©es.
                        Les sauvegardes automatiques sont cr√©√©es quotidiennement, mais vous pouvez aussi cr√©er des sauvegardes manuelles √† tout moment.
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498DB;">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ nb_backups }}</h3>
                        <p>Sauvegardes disponibles</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #2ecc71;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ backups[0].date.strftime('%d/%m/%Y %H:%M') if backups else 'Jamais' }}</h3>
                        <p>Derni√®re sauvegarde</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12;">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ "%.2f"|format(backups|sum(attribute='size')) if backups else '0.00' }} MB</h3>
                        <p>Espace utilis√©</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>30 jours</h3>
                        <p>R√©tention maximale</p>
                    </div>
                </div>
            </div>

            <!-- Liste des sauvegardes -->
            <div class="form-section">
                <h2><i class="fas fa-list"></i> Sauvegardes disponibles</h2>
                
                {% if backups %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date & Heure</th>
                                <th>Nom du fichier</th>
                                <th>Taille</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for backup in backups %}
                            <tr>
                                <td>
                                    <strong>{{ backup.date.strftime('%d/%m/%Y') }}</strong><br>
                                    <small>{{ backup.date.strftime('%H:%M:%S') }}</small>
                                </td>
                                <td><code>{{ backup.filename }}</code></td>
                                <td>{{ "%.2f"|format(backup.size) }} MB</td>
                                <td>
                                    {% if 'auto' in backup.filename %}
                                    <span class="badge badge-info">ü§ñ Automatique</span>
                                    {% else %}
                                    <span class="badge badge-success">‚úã Manuelle</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action" title="T√©l√©charger" 
                                                onclick="telechargerSauvegarde('{{ backup.filename }}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn-action" title="Restaurer" 
                                                onclick="restaurerSauvegarde('{{ backup.filename }}')">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button class="btn-action btn-danger" title="Supprimer" 
                                                onclick="supprimerSauvegarde('{{ backup.filename }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-database fa-4x"></i>
                    <h3>Aucune sauvegarde disponible</h3>
                    <p>Cr√©ez votre premi√®re sauvegarde pour prot√©ger vos donn√©es</p>
                    <button class="btn-primary" onclick="creerSauvegarde()">
                        <i class="fas fa-plus"></i> Cr√©er une sauvegarde
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Informations importantes -->
            <div class="form-section">
                <h2><i class="fas fa-exclamation-triangle"></i> Informations importantes</h2>
                
                <div class="warning-box">
                    <h3>‚ö†Ô∏è Avant de restaurer une sauvegarde :</h3>
                    <ul>
                        <li>‚úÖ Une sauvegarde de s√©curit√© sera cr√©√©e automatiquement</li>
                        <li>‚ö†Ô∏è Toutes les donn√©es actuelles seront remplac√©es</li>
                        <li>üîÑ L'application red√©marrera automatiquement</li>
                        <li>üíæ Assurez-vous d'avoir sauvegard√© vos derni√®res modifications</li>
                    </ul>
                </div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>üí° Bonnes pratiques :</strong>
                        <ul>
                            <li>Cr√©ez une sauvegarde avant toute op√©ration importante</li>
                            <li>T√©l√©chargez r√©guli√®rement les sauvegardes sur un disque externe</li>
                            <li>Les sauvegardes de plus de 30 jours sont supprim√©es automatiquement</li>
                            <li>V√©rifiez r√©guli√®rement que vos sauvegardes fonctionnent</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; {{ now.year }} {{ entreprise.nom }}</p>
        </footer>
    </div>

    <script>
        // Cr√©er une sauvegarde
        async function creerSauvegarde() {
            if (!confirm('Cr√©er une sauvegarde de la base de donn√©es maintenant ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/backup/create', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${result.message}\n\nFichier : ${result.filename}\nTaille : ${result.size}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Erreur : ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur de connexion');
            }
        }
        
        // T√©l√©charger une sauvegarde
        function telechargerSauvegarde(filename) {
            window.location.href = `/api/backup/download/${filename}`;
        }
        
        // Restaurer une sauvegarde
        async function restaurerSauvegarde(filename) {
            const confirmation = confirm(
                `‚ö†Ô∏è ATTENTION - RESTAURATION DE SAUVEGARDE ‚ö†Ô∏è\n\n` +
                `Vous allez restaurer la sauvegarde : ${filename}\n\n` +
                `‚úÖ Une sauvegarde de s√©curit√© sera cr√©√©e\n` +
                `‚ö†Ô∏è Toutes les donn√©es actuelles seront remplac√©es\n` +
                `üîÑ Vous devrez red√©marrer l'application\n\n` +
                `Voulez-vous continuer ?`
            );
            
            if (!confirmation) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backup/restore/${filename}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(
                        `‚úÖ ${result.message}\n\n` +
                        `Sauvegarde de s√©curit√© : ${result.safety_backup}\n\n` +
                        `‚ö†Ô∏è Vous devez maintenant RED√âMARRER l'application Flask\n` +
                        `(Arr√™tez avec CTRL+C et relancez avec python app.py)`
                    );
                } else {
                    alert('‚ùå Erreur : ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur de connexion');
            }
        }
        
        // Supprimer une sauvegarde
        async function supprimerSauvegarde(filename) {
            if (!confirm(`Voulez-vous vraiment supprimer la sauvegarde : ${filename} ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backup/delete/${filename}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    window.location.reload();
                } else {
                    alert('‚ùå Erreur : ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur de connexion');
            }
        }
    </script>

    <style>
        .info-box, .warning-box {
            padding: 20px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
            align-items: start;
        }
        
        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #2ecc71;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #f39c12;
        }
        
        .info-box i, .warning-box i {
            font-size: 24px;
            color: #2ecc71;
        }
        
        .warning-box i {
            color: #f39c12;
        }
        
        .info-box ul, .warning-box ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .info-box li, .warning-box li {
            margin: 5px 0;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-info {
            background: #3498DB;
            color: white;
        }
        
        .badge-success {
            background: #2ecc71;
            color: white;
        }
    </style>
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
</body>
</html>


