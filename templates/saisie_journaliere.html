<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie Journalière - {{ entreprise.nom }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo {{ entreprise.nom }}" class="logo-large">
                <div class="logo-text">
                    <h1><i class="fas fa-clipboard-list"></i> Saisie Journalière</h1>
                    <p class="subtitle">Enregistrement des livraisons quotidiennes</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="date-selector">
                    <button class="btn-date" onclick="changerDate(-1)"><i class="fas fa-chevron-left"></i></button>
                    <input type="date" id="date_globale" class="form-control date-input">
                    <button class="btn-date" onclick="changerDate(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <a href="{{ url_for('index') }}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </header>

        <nav class="main-nav">
            <a href="{{ url_for('index') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('saisie_journaliere') }}" class="nav-link active">
                <i class="fas fa-clipboard-list"></i> Saisie Journalière
            </a>
            <a href="{{ url_for('nouvelle_facture_employe') }}" class="nav-link">
                <i class="fas fa-file-invoice"></i> Bulletin Employé
            </a>
            <a href="{{ url_for('employes') }}" class="nav-link">
                <i class="fas fa-users"></i> Employés
            </a>
            <a href="{{ url_for('historique_livraisons') }}" class="nav-link">
                <i class="fas fa-history"></i> Historique
            </a>
        </nav>

        <!-- Messages flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <main class="main-content">
            <!-- Statistiques rapides -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #3498DB 0%, #2980b9 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-employes">0</h3>
                        <p>Employés actifs</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-journaux">0</h3>
                        <p>Journaux livrés</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-montant">0€</h3>
                        <p>Montant total</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="moyenne-livraison">0</h3>
                        <p>Moyenne/jour</p>
                    </div>
                </div>
            </div>

            <!-- Formulaire de saisie -->
            <div class="form-section">
                <h2><i class="fas fa-plus-circle"></i> Nouvelle Livraison</h2>
                
                <form id="formLivraison">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_livraison">Date *</label>
                            <input type="date" id="date_livraison" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employe_id">Employé *</label>
                            <select id="employe_id" class="form-control" required onchange="chargerDerniereLivraison()">
                                <option value="">— Sélectionner —</option>
                                {% for employe in employes %}
                                <option value="{{ employe.id }}">{{ employe.nom_complet() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre_journaux">
                                <i class="fas fa-newspaper"></i> Nombre de journaux *
                            </label>
                            <div class="input-with-buttons">
                                <input type="number" id="nombre_journaux" min="0" value="0" 
                                       class="form-control" required onchange="calculerMontant()">
                                <div class="input-buttons">
                                    <button type="button" class="btn-quantity" onclick="ajusterQuantite(-10)">
                                        <i class="fas fa-minus"></i> 10
                                    </button>
                                    <button type="button" class="btn-quantity" onclick="ajusterQuantite(10)">
                                        <i class="fas fa-plus"></i> 10
                                    </button>
                                    <button type="button" class="btn-quantity" onclick="ajusterQuantite(50)">
                                        <i class="fas fa-plus"></i> 50
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="prix_unitaire">
                                <i class="fas fa-euro-sign"></i> Prix par journal (€)
                            </label>
                            <div class="input-with-buttons">
                                <input type="number" id="prix_unitaire" min="0" step="0.01" value="0.50" 
                                       class="form-control" onchange="calculerMontant()">
                                <div class="input-buttons">
                                    <button type="button" class="btn-price" onclick="setPrix(0.50)">0.50</button>
                                    <button type="button" class="btn-price" onclick="setPrix(0.75)">0.75</button>
                                    <button type="button" class="btn-price" onclick="setPrix(1.00)">1.00</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="montant_jour">
                                <i class="fas fa-calculator"></i> Montant du jour (€) *
                            </label>
                            <input type="number" id="montant_jour" min="0" step="0.01" value="0" 
                                   class="form-control" required>
                            <small class="help-text">Calculé automatiquement ou modifiable manuellement</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">
                                <i class="fas fa-sticky-note"></i> Notes
                            </label>
                            <input type="text" id="notes" class="form-control" 
                                   placeholder="Observations, retards, problèmes...">
                        </div>
                    </div>
                    
                    <!-- Dernière livraison info -->
                    <div class="last-delivery-info" id="last-delivery-info" style="display: none;">
                        <div class="info-card">
                            <h4><i class="fas fa-history"></i> Dernière livraison</h4>
                            <p id="last-delivery-text"></p>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="resetFormulaire()">
                            <i class="fas fa-redo"></i> Réinitialiser
                        </button>
                        <button type="submit" class="btn-primary" id="btn-enregistrer">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn-success" onclick="enregistrerEtNouveau()">
                            <i class="fas fa-plus-circle"></i> Enregistrer et nouveau
                        </button>
                    </div>
                </form>
            </div>

            <!-- Liste des livraisons du jour -->
            <div class="form-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Livraisons du <span id="date-titre">Aujourd'hui</span></h2>
                    <div class="header-buttons">
                        <button class="btn-export" onclick="exporterLivraisons()">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                        <button class="btn-refresh" onclick="chargerLivraisonsJour()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                </div>
                
                <div class="table-actions">
                    <div class="search-box">
                        <input type="text" id="search-livraisons" class="form-control" 
                               placeholder="Rechercher un employé..." onkeyup="filtrerLivraisons()">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="table-summary">
                        <span id="summary-total">0 livraisons</span>
                        <span id="summary-journaux">0 journaux</span>
                        <span id="summary-montant">0€</span>
                    </div>
                </div>
                
                <div id="livraisonsJour" class="table-responsive">
                    <!-- Chargé dynamiquement -->
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="btn-pagination" onclick="prevPage()">
                        <i class="fas fa-chevron-left"></i> Précédent
                    </button>
                    <span id="page-info">Page 1</span>
                    <button class="btn-pagination" onclick="nextPage()">
                        Suivant <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Résumé rapide -->
            <div class="quick-summary">
                <div class="summary-card">
                    <h3><i class="fas fa-chart-bar"></i> Performance du jour</h3>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="summary-label">Meilleur employé</span>
                            <span class="summary-value" id="best-employee">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Journaux moyens</span>
                            <span class="summary-value" id="avg-journaux">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Valeur moyenne</span>
                            <span class="summary-value" id="avg-value">0€</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; {{ now.year }} {{ entreprise.nom }} - Saisie journalière</p>
            <p class="last-update">Dernière mise à jour : <span id="last-update-time">{{ now.strftime('%H:%M:%S') }}</span></p>
        </footer>
    </div>

    <script>
        // Variables globales
        let currentPage = 1;
        const itemsPerPage = 10;
        let allLivraisons = [];
        let currentDate = new Date().toISOString().split('T')[0];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Date d'aujourd'hui par défaut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date_livraison').value = today;
            document.getElementById('date_globale').value = today;
            
            // Mettre à jour le titre
            updateDateTitle(today);
            
            chargerLivraisonsJour();
            chargerStatistiques();
            
            // Raccourcis clavier
            setupKeyboardShortcuts();
            
            // Auto-save draft
            setupAutoSave();
        });

        // Mettre à jour le titre avec la date
        function updateDateTitle(dateStr) {
            const date = new Date(dateStr);
            const today = new Date().toISOString().split('T')[0];
            
            if (dateStr === today) {
                document.getElementById('date-titre').textContent = 'Aujourd\'hui';
            } else if (dateStr === new Date(Date.now() - 86400000).toISOString().split('T')[0]) {
                document.getElementById('date-titre').textContent = 'Hier';
            } else {
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('date-titre').textContent = date.toLocaleDateString('fr-FR', options);
            }
        }

        // Changer la date globale
        function changerDate(days) {
            const dateInput = document.getElementById('date_globale');
            const date = new Date(dateInput.value);
            date.setDate(date.getDate() + days);
            const newDate = date.toISOString().split('T')[0];
            
            dateInput.value = newDate;
            document.getElementById('date_livraison').value = newDate;
            currentDate = newDate;
            updateDateTitle(newDate);
            chargerLivraisonsJour();
            chargerStatistiques();
        }

        // Calculer le montant automatiquement
        function calculerMontant() {
            const nbJournaux = parseFloat(document.getElementById('nombre_journaux').value) || 0;
            const prixUnit = parseFloat(document.getElementById('prix_unitaire').value) || 0;
            const montant = nbJournaux * prixUnit;
            
            document.getElementById('montant_jour').value = montant.toFixed(2);
        }

        // Ajuster la quantité
        function ajusterQuantite(quantite) {
            const input = document.getElementById('nombre_journaux');
            const current = parseInt(input.value) || 0;
            input.value = Math.max(0, current + quantite);
            calculerMontant();
        }

        // Définir le prix
        function setPrix(prix) {
            document.getElementById('prix_unitaire').value = prix.toFixed(2);
            calculerMontant();
        }

        // Charger la dernière livraison de l'employé
        async function chargerDerniereLivraison() {
            const employeId = document.getElementById('employe_id').value;
            if (!employeId) return;
            
            try {
                const response = await fetch(`/api/employes/${employeId}/livraisons/recentes`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.derniere_livraison) {
                        const liv = data.derniere_livraison;
                        const infoDiv = document.getElementById('last-delivery-info');
                        const textDiv = document.getElementById('last-delivery-text');
                        
                        const date = new Date(liv.date_livraison);
                        const dateStr = date.toLocaleDateString('fr-FR');
                        
                        textDiv.innerHTML = `
                            Le ${dateStr} : ${liv.nombre_journaux} journaux pour ${liv.montant_jour.toFixed(2)}€
                            ${liv.notes ? `<br><em>${liv.notes}</em>` : ''}
                        `;
                        infoDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Erreur chargement dernière livraison:', error);
            }
        }

        // Enregistrer une livraison
        document.getElementById('formLivraison').addEventListener('submit', async function(e) {
            e.preventDefault();
            await enregistrerLivraison();
        });

        async function enregistrerLivraison() {
            const btn = document.getElementById('btn-enregistrer');
            const originalText = btn.innerHTML;
            
            const data = {
                date_livraison: document.getElementById('date_livraison').value,
                employe_id: document.getElementById('employe_id').value,
                nombre_journaux: parseInt(document.getElementById('nombre_journaux').value),
                montant_jour: parseFloat(document.getElementById('montant_jour').value),
                notes: document.getElementById('notes').value
            };
            
            // Validation
            if (!data.date_livraison || !data.employe_id) {
                alert('⚠️ Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (data.nombre_journaux <= 0) {
                alert('⚠️ Le nombre de journaux doit être supérieur à 0');
                return;
            }
            
            if (data.montant_jour <= 0) {
                alert('⚠️ Le montant doit être supérieur à 0');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/livraisons', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('✅ ' + result.message, 'success');
                    chargerLivraisonsJour();
                    chargerStatistiques();
                    clearAutoSave();
                    
                    if (!result.continue) {
                        resetFormulaire();
                    }
                } else {
                    showNotification('❌ ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('❌ Erreur de connexion', 'error');
                console.error('Erreur:', error);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Enregistrer et nouveau
        async function enregistrerEtNouveau() {
            const result = await enregistrerLivraison();
            if (result && result.success) {
                resetFormulaire();
            }
        }

        // Réinitialiser le formulaire
        function resetFormulaire() {
            document.getElementById('formLivraison').reset();
            document.getElementById('date_livraison').value = currentDate;
            document.getElementById('prix_unitaire').value = '0.50';
            document.getElementById('montant_jour').value = '0';
            document.getElementById('nombre_journaux').value = '0';
            document.getElementById('last-delivery-info').style.display = 'none';
        }

        // Charger les livraisons du jour
        async function chargerLivraisonsJour() {
            try {
                const response = await fetch('/api/livraisons');
                const livraisons = await response.json();
                
                // Filtrer par date sélectionnée
                allLivraisons = livraisons.filter(l => {
                    try {
                        const dateLivr = l.date_livraison.split('/').reverse().join('-');
                        return dateLivr === currentDate;
                    } catch (e) {
                        return false;
                    }
                });
                
                afficherLivraisonsPage(1);
                updateSummary();
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de chargement', 'error');
            }
        }

        // Afficher les livraisons paginées
        function afficherLivraisonsPage(page) {
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageLivraisons = allLivraisons.slice(start, end);
            
            afficherLivraisonsJourList(pageLivraisons);
            updatePagination();
        }

        // Afficher la liste des livraisons
        function afficherLivraisonsJourList(livraisons) {
            const container = document.getElementById('livraisonsJour');
            
            if (livraisons.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox fa-3x"></i>
                        <h3>Aucune livraison enregistrée</h3>
                        <p>Utilisez le formulaire ci-dessus pour ajouter une livraison</p>
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employé</th>
                            <th>Journaux</th>
                            <th>Prix unit.</th>
                            <th>Montant</th>
                            <th>Notes</th>
                            <th>Heure</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            livraisons.forEach(l => {
                const prixUnitaire = l.montant_jour / l.nombre_journaux;
                const dateLivraison = new Date(l.date_livraison);
                const heure = dateLivraison.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <tr class="livraison-row" id="livraison-${l.id}">
                        <td>
                            <div class="employe-info">
                                <strong>${l.employe_nom}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-info">${l.nombre_journaux}</span>
                        </td>
                        <td>${prixUnitaire.toFixed(2)}€</td>
                        <td>
                            <span class="montant-value">${l.montant_jour.toFixed(2)}€</span>
                        </td>
                        <td class="notes-cell">
                            <span class="notes-text" title="${l.notes || ''}">
                                ${l.notes ? l.notes.substring(0, 30) + (l.notes.length > 30 ? '...' : '') : '-'}
                            </span>
                        </td>
                        <td>${heure}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-edit" onclick="modifierLivraison(${l.id})" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-danger" onclick="supprimerLivraison(${l.id})" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            document.getElementById('pagination').style.display = allLivraisons.length > itemsPerPage ? 'flex' : 'none';
        }

        // Mettre à jour la pagination
        function updatePagination() {
            const totalPages = Math.ceil(allLivraisons.length / itemsPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} / ${totalPages}`;
        }

        // Page précédente
        function prevPage() {
            if (currentPage > 1) {
                afficherLivraisonsPage(currentPage - 1);
            }
        }

        // Page suivante
        function nextPage() {
            const totalPages = Math.ceil(allLivraisons.length / itemsPerPage);
            if (currentPage < totalPages) {
                afficherLivraisonsPage(currentPage + 1);
            }
        }

        // Filtrer les livraisons
        function filtrerLivraisons() {
            const search = document.getElementById('search-livraisons').value.toLowerCase();
            if (!search) {
                afficherLivraisonsPage(1);
                return;
            }
            
            const filtered = allLivraisons.filter(l => 
                l.employe_nom.toLowerCase().includes(search) ||
                (l.notes && l.notes.toLowerCase().includes(search))
            );
            
            const container = document.getElementById('livraisonsJour');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search fa-3x"></i>
                        <h3>Aucun résultat trouvé</h3>
                        <p>Aucune livraison ne correspond à votre recherche</p>
                    </div>
                `;
                return;
            }
            
            // Réafficher avec les résultats filtrés
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employé</th>
                            <th>Journaux</th>
                            <th>Montant</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filtered.forEach(l => {
                html += `
                    <tr id="livraison-${l.id}">
                        <td><strong>${l.employe_nom}</strong></td>
                        <td>${l.nombre_journaux}</td>
                        <td>${l.montant_jour.toFixed(2)}€</td>
                        <td>${l.notes || '-'}</td>
                        <td>
                            <button class="btn-action btn-danger" onclick="supprimerLivraison(${l.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // Mettre à jour le résumé
        function updateSummary() {
            const totalLivraisons = allLivraisons.length;
            const totalJournaux = allLivraisons.reduce((sum, l) => sum + l.nombre_journaux, 0);
            const totalMontant = allLivraisons.reduce((sum, l) => sum + l.montant_jour, 0);
            
            document.getElementById('summary-total').textContent = `${totalLivraisons} livraisons`;
            document.getElementById('summary-journaux').textContent = `${totalJournaux} journaux`;
            document.getElementById('summary-montant').textContent = `${totalMontant.toFixed(2)}€`;
            
            // Mettre à jour les stats globales
            document.getElementById('total-journaux').textContent = totalJournaux;
            document.getElementById('total-montant').textContent = `${totalMontant.toFixed(2)}€`;
            
            // Calculer la moyenne par livraison
            const moyenne = totalLivraisons > 0 ? (totalMontant / totalLivraisons).toFixed(2) : '0';
            document.getElementById('moyenne-livraison').textContent = `${moyenne}€`;
            
            // Trouver le meilleur employé
            if (totalLivraisons > 0) {
                const employesStats = {};
                allLivraisons.forEach(l => {
                    if (!employesStats[l.employe_nom]) {
                        employesStats[l.employe_nom] = { total: 0, count: 0 };
                    }
                    employesStats[l.employe_nom].total += l.montant_jour;
                    employesStats[l.employe_nom].count++;
                });
                
                let bestEmploye = null;
                let maxMontant = 0;
                
                Object.entries(employesStats).forEach(([nom, stats]) => {
                    if (stats.total > maxMontant) {
                        maxMontant = stats.total;
                        bestEmploye = nom;
                    }
                });
                
                if (bestEmploye) {
                    document.getElementById('best-employee').textContent = bestEmploye;
                    document.getElementById('avg-journaux').textContent = (totalJournaux / totalLivraisons).toFixed(1);
                    document.getElementById('avg-value').textContent = `${moyenne}€`;
                }
            }
        }

        // Charger les statistiques
        async function chargerStatistiques() {
            try {
                // Compter les employés actifs
                document.getElementById('total-employes').textContent = {{ employes|length }};
                
                // Mettre à jour les autres stats via updateSummary
                updateSummary();
            } catch (error) {
                console.error('Erreur statistiques:', error);
            }
        }

        // Modifier une livraison
        async function modifierLivraison(id) {
            try {
                const response = await fetch(`/api/livraisons/${id}`);
                if (response.ok) {
                    const livraison = await response.json();
                    
                    // Remplir le formulaire
                    document.getElementById('date_livraison').value = livraison.date_livraison.split('/').reverse().join('-');
                    document.getElementById('employe_id').value = livraison.employe_id;
                    document.getElementById('nombre_journaux').value = livraison.nombre_journaux;
                    document.getElementById('montant_jour').value = livraison.montant_jour;
                    document.getElementById('notes').value = livraison.notes || '';
                    
                    // Calculer le prix unitaire
                    const prixUnitaire = livraison.montant_jour / livraison.nombre_journaux;
                    document.getElementById('prix_unitaire').value = prixUnitaire.toFixed(2);
                    
                    // Changer le bouton en "Modifier"
                    const btn = document.getElementById('btn-enregistrer');
                    btn.innerHTML = '<i class="fas fa-edit"></i> Modifier';
                    btn.onclick = async function() {
                        await mettreAJourLivraison(id);
                    };
                    
                    // Scroll vers le formulaire
                    document.getElementById('formLivraison').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showNotification('❌ Erreur de chargement', 'error');
            }
        }

        // Mettre à jour une livraison
        async function mettreAJourLivraison(id) {
            const data = {
                date_livraison: document.getElementById('date_livraison').value,
                employe_id: document.getElementById('employe_id').value,
                nombre_journaux: parseInt(document.getElementById('nombre_journaux').value),
                montant_jour: parseFloat(document.getElementById('montant_jour').value),
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch(`/api/livraisons/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showNotification('✅ Livraison modifiée', 'success');
                    resetFormulaire();
                    chargerLivraisonsJour();
                    chargerStatistiques();
                    
                    // Restaurer le bouton
                    const btn = document.getElementById('btn-enregistrer');
                    btn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
                    btn.onclick = null;
                }
            } catch (error) {
                showNotification('❌ Erreur de modification', 'error');
            }
        }

        // Supprimer une livraison
        async function supprimerLivraison(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette livraison ?')) return;
            
            try {
                const response = await fetch(`/api/livraisons/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('✅ Livraison supprimée', 'success');
                    document.getElementById(`livraison-${id}`).remove();
                    chargerStatistiques();
                } else {
                    showNotification('❌ Erreur de suppression', 'error');
                }
            } catch (error) {
                showNotification('❌ Erreur de connexion', 'error');
            }
        }

        // Exporter les livraisons
        function exporterLivraisons() {
            if (allLivraisons.length === 0) {
                alert('Aucune livraison à exporter');
                return;
            }
            
            const date = new Date(currentDate);
            const dateStr = date.toLocaleDateString('fr-FR').replace(/\//g, '-');
            let csv = 'Employé,Journaux,Montant,Notes,Date\n';
            
            allLivraisons.forEach(l => {
                csv += `"${l.employe_nom}",${l.nombre_journaux},${l.montant_jour},"${l.notes || ''}",${l.date_livraison}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `livraisons-${dateStr}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Afficher une notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Raccourcis clavier
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S pour enregistrer
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('formLivraison').submit();
                }
                
                // Échap pour réinitialiser
                if (e.key === 'Escape') {
                    resetFormulaire();
                }
                
                // Ctrl+Enter pour enregistrer et nouveau
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    enregistrerEtNouveau();
                }
            });
        }

        // Auto-save du formulaire
        function setupAutoSave() {
            const form = document.getElementById('formLivraison');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    saveFormDraft();
                });
            });
            
            // Charger le brouillon au démarrage
            loadFormDraft();
        }

        function saveFormDraft() {
            const formData = {
                date_livraison: document.getElementById('date_livraison').value,
                employe_id: document.getElementById('employe_id').value,
                nombre_journaux: document.getElementById('nombre_journaux').value,
                prix_unitaire: document.getElementById('prix_unitaire').value,
                montant_jour: document.getElementById('montant_jour').value,
                notes: document.getElementById('notes').value
            };
            
            localStorage.setItem('livraison_draft', JSON.stringify(formData));
        }

        function loadFormDraft() {
            const draft = localStorage.getItem('livraison_draft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && formData[key]) {
                            element.value = formData[key];
                        }
                    });
                } catch (e) {
                    console.error('Erreur chargement brouillon:', e);
                }
            }
        }

        function clearAutoSave() {
            localStorage.removeItem('livraison_draft');
        }

        // Mettre à jour l'heure de dernière mise à jour
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('fr-FR');
            document.getElementById('last-update-time').textContent = timeStr;
        }

        // Auto-refresh toutes les 30 secondes
        setInterval(() => {
            if (document.hidden === false) {
                chargerLivraisonsJour();
                updateLastUpdateTime();
            }
        }, 30000);
    </script>

    <style>
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-input {
            width: 150px;
        }
        
        .btn-date {
            background: #3498DB;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-date:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .flash-messages {
            margin-bottom: 25px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
        }
        
        .stat-content h3 {
            font-size: 42px;
            margin: 0;
            color: #2C3E50;
            font-weight: 700;
        }
        
        .stat-content p {
            color: #7f8c8d;
            font-size: 16px;
            margin: 5px 0 0 0;
        }
        
        .input-with-buttons {
            display: flex;
            gap: 10px;
        }
        
        .input-with-buttons .form-control {
            flex: 1;
        }
        
        .input-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-quantity, .btn-price {
            background: #3498DB;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-quantity:hover, .btn-price:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .info-card {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .info-card h4 {
            margin: 0 0 10px 0;
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            background: #9b59b6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-export:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }
        
        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding-right: 40px;
        }
        
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }
        
        .table-summary {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .table-summary span {
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .notes-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .notes-text {
            cursor: help;
        }
        
        .montant-value {
            font-weight: 600;
            color: #27ae60;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-action {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-edit {
            color: #3498DB;
        }
        
        .btn-edit:hover {
            background: #3498DB;
            color: white;
        }
        
        .btn-danger {
            color: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #e74c3c;
            color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn-pagination {
            background: #3498DB;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-pagination:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .quick-summary {
            margin-top: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .summary-card h3 {
            color: #2C3E50;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            display: block;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .summary-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #2C3E50;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
            max-width: 400px;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .notification-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .notification-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .notification button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: inherit;
            margin-left: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state h3 {
            margin: 15px 0 10px 0;
            color: #2C3E50;
        }
        
        .last-update {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .date-selector {
                width: 100%;
                justify-content: center;
            }
            
            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .input-with-buttons {
                flex-direction: column;
            }
            
            .input-buttons {
                justify-content: center;
            }
        }
    </style>
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
</body>
</html>


